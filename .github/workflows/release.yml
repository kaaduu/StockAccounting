name: Release Application

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

       - name: Build with script
         run: |
           chmod +x build.sh
           ./build.sh

       - name: Verify Build Output
         run: |
           echo "Checking build output..."
           ls -la dist/
           if [ ! -f "dist/StockAccounting.jar" ]; then
             echo "ERROR: StockAccounting.jar not found in dist/"
             exit 1
           fi
           echo "Build verification passed."

       - name: Prepare Release Package
         run: |
           echo "Creating release package..."
           cd dist
           ls -la
           zip -r ../StockAccounting-${{ github.ref_name }}.zip ./*
           echo "Package created successfully"

       - name: Verify Package
         run: |
           echo "Verifying package contents..."
           unzip -l StockAccounting-${{ github.ref_name }}.zip
           ls -la StockAccounting-${{ github.ref_name }}.zip

       - name: Create Release
         uses: softprops/action-gh-release@v2
         if: startsWith(github.ref, 'refs/tags/')
         with:
           files: StockAccounting-${{ github.ref_name }}.zip
           generate_release_notes: true
           fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
