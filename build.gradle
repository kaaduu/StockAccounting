plugins {
  id 'java'
  id 'application'
}

group = 'cz.datesoft'
version = 'dev'

java {
  toolchain {
    languageVersion = JavaLanguageVersion.of(21)
  }
}

// Compile with Java 21 bytecode level.
tasks.withType(JavaCompile).configureEach {
  options.release = 21
}

tasks.withType(JavaExec).configureEach {
  javaLauncher = javaToolchains.launcherFor {
    languageVersion = JavaLanguageVersion.of(21)
  }
}

repositories {
  mavenCentral()
}

sourceSets {
  main {
    java {
      srcDirs = ['src']
    }
    resources {
      srcDirs = ['src']
      exclude '**/*.java'
      // Generated by Gradle task (avoid duplicate with legacy file).
      exclude 'version.properties'
    }
  }
}

dependencies {
  implementation fileTree(dir: 'libjar', include: ['*.jar'], exclude: ['*debug*.jar'])
  runtimeOnly fileTree(dir: 'libjar', include: ['*.jar'], exclude: ['*debug*.jar'])

  implementation 'com.formdev:flatlaf:3.7'
  
  // Google Drive API for cloud sync
  implementation 'com.google.api-client:google-api-client:2.6.0'
  implementation 'com.google.oauth-client:google-oauth-client-jetty:1.36.0'
  implementation 'com.google.apis:google-api-services-drive:v3-rev20240123-2.0.0'
  implementation 'com.google.http-client:google-http-client-gson:1.44.2'
}

// Ensure distro contains Maven dependencies (e.g., FlatLaf)
tasks.named('installDist') {
  dependsOn tasks.named('jar')
}

application {
  mainClass = 'cz.datesoft.stockAccounting.Main'
}

tasks.named('jar') {
  archiveFileName = 'StockAccounting.jar'
  manifest {
    attributes(
        'Main-Class': application.mainClass.get()
    )
  }
}

def generatedVersionDir = layout.buildDirectory.dir('generated-resources/version')

tasks.register('generateVersionProperties') {
  outputs.dir(generatedVersionDir)

  doLast {
    def outDir = generatedVersionDir.get().asFile
    outDir.mkdirs()
    def versionFile = new File(outDir, 'version.properties')

    def v = 'dev-build'
    try {
      def proc = ['git', 'describe', '--tags', '--always'].execute(null, project.rootDir)
      def text = proc.text?.trim()
      if (proc.waitFor() == 0 && text) {
        v = text
      }
    } catch (Exception ignored) {
      // Keep dev-build
    }

    versionFile.text = "version=${v}\n"
  }
}

tasks.named('processResources') {
  dependsOn tasks.named('generateVersionProperties')
  from(generatedVersionDir)
  duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}
